{% extends 'layout.html' %}

{% set active_page = "more" %}

{% from "macros.html" import form_entry %}

{% block body %}
<div class="transactions">
  <h2>Transaktionshistorik</h2>
  <form class="date-range-form" method="POST">
    {{ form.csrf_token }}
    {{ form_entry(form.start) }}
    {{ form_entry(form.end) }}
    <button>Sök</button>
  </form>
  {% if transactions.all() %}
  <div class="table-wrap">
    <table class="transaction-history">
      <tr>
        <th>Användare</th>
        <th>Skapad av</th>
        <th>Transaktionstyp</th>
        <th>Meddelande</th>
        <th>Värde</th>
        <th>Datum</th>
      </tr>
      {% for transaction in transactions %}
      <tr>
        <td class="user">
          <span>
            {{ transaction.user.full_name }}
          </span>
        </td>
        <td class="user">
          <span>
            {% if transaction.created_by %}
            {{ transaction.created_by.full_name }}
            {% else %}
            Okänt
            {% endif %}
          </span>
        </td>
        <td class="type">
          <span>
            {% if transaction.type == 'streque' %}
            Streque
            {% elif transaction.type == 'admin_transaction' %}
            Admin
            {% elif transaction.type == 'user_transaction' %}
            Pay
            {% else %}
            {{ transaction.type }}
            {% endif %}
          </span>
        </td>
        <td class="text">
          <span>
            {{ transaction.text }}
          </span>
        </td>
        <td class="value">
          <span>
            {{ transaction.formatted_value }}
          </span>
        </td>
        <td class="timestamp">
          <span>
            {{ format_datetime(transaction.timestamp, "yyyy-MM-dd HH:mm") }}
          </span>
        </td>
        <td>
          {% if not transaction.voided %}
          <form id="void-transaction-{{ transaction.id }}"
                class="transaction void-form"
                method="POST">

            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

            <button class="transaction void-button"
                    formaction="{{ url_for('strequeadmin.void_transaction', transaction_id=transaction.id) }}"
                    data-transactionid="{{ transaction.id }}"
                    data-csrftoken="{{ csrf_token() }}">
              Ångra
            </button>
          </form>
          {% else %}
          Ångrad
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% else %}
  <p>Inga transaktioner funna.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
